chrome.runtime.onMessage.addListener((function(e,o,t){const n=e.highlightedText,s=/[^\w\s]/g,r=/[a-zA-z]{2,4}([-\s]|(&nbsp;))[0-9]{3,4}/.exec(n);if(r)try{const e=r[0].replace(s," ").trim().toLocaleUpperCase().split(/\s|&nbsp;/);3===e[1].length&&(e[1]+="0");const o={inputcourse:e[0]+"-"+e[1]};chrome.storage.local.set(o,(()=>{console.log("Input course saved")}))}catch(e){console.log(e)}})),chrome.runtime.onMessage.addListener(((e,o,t)=>{if(console.log("ðŸ”” background.onMessage got:",e),"getAiSelection"===e.action)return chrome.storage.local.get(["openaiKey"],(async({openaiKey:o})=>{if(!o)return void t({error:"No OpenAI key saved"});const n={role:"user",content:`Here are the courses Iâ€™m interested in: ${e.courses.map((e=>{const o=e.courseData;return[`â€¢ ${e.id}: ${e.title}`,`    Course Quality: ${o.course_quality}`,`    Instructor Quality: ${o.instructor_quality}`,`    Difficulty: ${o.difficulty}`,`    Work Required: ${o.work_required}`].join("\n")})).join("\n\n")} \n        Based on their stats like workload, difficulty, and quality averages, which one would you recommend I take this coming semester? Explain briefly.`};try{const e=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",credentials:"omit",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify({model:"gpt-4o",messages:[{role:"system",content:"You are a helpful academic advisor for Penn undergrads."},{role:"user",content:n.content}],max_tokens:200})});console.log("API Response: ",e);const s=await e.json();console.log("ðŸ—‚ full OpenAI JSON",s);const r=s.choices[0]?.message?.content||"No response";t({answer:r})}catch(e){console.error(e),t({answer:"Error calling OpenAI."})}})),!0}));